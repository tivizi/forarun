<!doctype html><html>
<head>
    <meta charset="utf-8" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
    <link href="/common/resources/css/global.css" rel="stylesheet" data-role="global">
    <script src="/common/resources/js/global.js"></script>
    <script src="https://s3.pstatp.com/cdn/expire-1-M/marked/0.6.2/marked.min.js" type="application/javascript"></script>
    <script type="text/javascript">
        marked.setOptions({
            gfm: true,
            breaks: true
        })
    </script>
    <title>{{.Thread.Title}} - {{.SiteContext.Site.Name}}</title>
    <style>
        @font-face {
            font-family: josefin sans;
            font-style: normal;
            font-weight: 400;
            src: url(//lib.baomitu.com/fonts/josefin-sans/josefin-sans-regular.eot);
            src: local("Josefin Sans"),local("JosefinSans-Normal"),url(//lib.baomitu.com/fonts/josefin-sans/josefin-sans-regular.eot?#iefix) format("embedded-opentype"),url(//lib.baomitu.com/fonts/josefin-sans/josefin-sans-regular.woff2) format("woff2"),url(//lib.baomitu.com/fonts/josefin-sans/josefin-sans-regular.woff) format("woff"),url(//lib.baomitu.com/fonts/josefin-sans/josefin-sans-regular.ttf) format("truetype"),url(//lib.baomitu.com/fonts/josefin-sans/josefin-sans-regular.svg#JosefinSans) format("svg")
        }
        .t-main,.t-reply {background-color: #fff;}
        h1 {font-size: 20px;padding: 10px;}
        .ops {padding: 0 10px;line-height: 22px;}
        .ops .author {color: #444;font-weight: bolder;}
        .ops .author,.ops .time,.ops .viewcount {display: inline-block;}
        .ops .author a {font-size: 13px;color: #787878;}
        .ops .time {color: #ccc;font-size: 12px;margin: 0 0 0 5px;}
        .ops .time span {color: #888;font-size: 12px;}
        .ops .viewcount{font-size: 12px;margin-left: 5px;}
        .ops .viewcount span {color: #999;font-size: 12px;font-style: italic;margin: 2px;}
        .face-img {width: 26px;display: inline;}
        .content {padding: 10px;line-height: 1.6;word-break: break-word;color: #000;}
        .content a {border-bottom: .5px dashed #ccc;color: green;}
        .content .empty-content {text-align: center;color: #ccc;font-size: 16px;padding: 10px;line-height: 28px;}
        .content code {
            background: #f5f5f5;padding: 0 3px;display: inline-block;margin: 0 2px;color: #000;font-size: 13px;line-height: 1.2;
            font-family: Consolas,panic sans,dejavu sans mono,bitstream vera sans mono,Menlo,microsoft yahei,monospace;
            border: 1px solid #eee;
        }
        .content pre code {display: block;padding: 10px 15px;margin: 0 0px;margin-bottom: 15px;overflow-x: auto;}
        .content p {margin-bottom: 16px;color: #222;line-height: 1.8;font-size: 15px;}
        .content>:last-child,.content blockquote>:last-child {margin-bottom: 0;}
        .content h1 {font-size: 22px;color: #000;padding-left: 0;}
        .content h2 {font-size: 18px;border-bottom: 1px solid #eee;line-height: 26px;padding: 0;margin: 15px 0;color: #000;}
        .content h3, .content h4 {line-height: 22px;padding: 5px 0;margin: 5px 0;color: #000;}
        .content blockquote {padding: 10px 10px 10px 20px;margin: 10px 0;color: #222;background: #f8f8f8;border-left: 3px solid #159957;}
        .content ol {padding-left: 20px;}
        .content ol li {margin: 12px 0;background-color: #fff;color: #222;list-style: decimal;line-height: 1.8;}
        .content ul {padding-left: 20px;}
        .content ul li {color: #222;list-style: circle;line-height: 1.8;}
        .content strong {color: #000;}
        .content em {color: #000;}
        .content p img {
            max-width: 90%;
            max-height: 280px;
            margin: 10px auto;
            display: block;
            border: 10px solid #ccc;
            border-radius: 2px;
        }
        .content p .face-img, .content p a img {
            max-width: none;
            box-shadow: none;
            display: inline;
            border-radius: inherit;
            border: none;
            margin: 0;
        }
        .good {
            width: 50px;height: 50px;
            text-align: center;
            border-radius: 50%;
            margin: 15px auto;
            background-color: #E50012;
            filter: blur(-10px);
            display: block;
        }
        .good .icon {margin-top: 5px;}
        .good span {color: #fff;font-size: 12px;display: block;}
        .good:hover {background-color: #ccc;}
        .good:hover span {color: #000;}
        .reply {padding: 10px 6px;border-top: 0.4rem solid rgba(247,248,250,1);margin-top: 20px;}
        .reply .empty {padding: 12px 5px;border-radius: 2px;}
        .reply li {padding: 8px 4px;border-radius: 3px;}
        .reply li:hover {background-color: #f0f0f0;}
        .reply .author {color: #333;font-weight: bolder;line-height: 22px;}
        .reply .author a {color: #787878;font-size: 14px;}
        .reply .author span {padding: 2px 5px;background-color: #f6f6f6;color: #69c;border-radius: 3px;font-size: 12px;line-height: 20px;margin-left: 2px;}
        .reply .rc {padding: 5px 0;}
        .reply .rc p,.reply .rc p a {font-size: 14px;}
        .to-reply {padding: 10px 20px 10px 10px;}
        .to-reply textarea {padding: 10px 5px; max-width: 100%;min-width: 100%;height: 22px;min-height: 22px;max-height: 200px;}
        .to-reply textarea:focus {min-height: 80px;outline: none;}
        .to-reply button {padding: 3px 10px;margin: 10px 0;font-size: 14px;}
        .faces {
            position: fixed;
            margin: auto;
            bottom: 100px;
            width: 320px;
            left: 0;right: 0;
            background-color: #fff;
            padding: 10px;
            box-shadow: 0 0 10px #ccc;
            border-radius: 3px;
            display: none;
        }
        .faces li {display: inline-block;padding: 5px;}
        .faces li:hover {background: #f0f0f0;cursor: pointer;}
        .faces li img {width: 26px;}
        @media screen and (min-width: 720px) {
            .faces {bottom: 200px;width: 720px;}
            .t-main,.t-reply {border-radius: 3px;padding-bottom: 1px;}
            .reply li:hover {background-color: #fff;}
        }
    </style>
    <link href="/common/resources/css/bbs/{{.SiteContext.Site.ID.Hex}}.css" rel="stylesheet" data-role="global">
</head>
<body>
    {{rwctx .SiteContext.Site.Header .SiteContext}}
    <nav>
        <div>
            <ul>
                <li><a href="/">首页</a></li>
                {{range .BBSContexts}}
                <li><a href="/bbs-{{.ID.Hex}}.html">{{.Name}}</a></li>
                {{end}}
                <li>帖子</li>
            </ul>
        </div>
    </nav>
    <main>
    <div class="mainBar">
        <div class="t-main">
            <h1>{{.Thread.Title}}</h1>
            <div class="ops">
                <div class="author"><a href="/profile/{{.Thread.Author.Name}}">{{.Thread.Author.Name}}</a></div>
                <div class="time">发表于<span>{{intelliTime .Thread.CreateTime}}</span></div>
                <div class="viewcount"><span>{{.Thread.ViewCount}}</span>阅</div>
            </div>
            <article class="content">{{rwubb .Thread.Content}}</article>
            <a href="javascript:;" onclick="good()" class="good" id="goodbtn" title="觉得本帖很赞">
                <svg t="1609061852877" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2496" width="22" height="22"><path d="M832.9 694.3c-115.2 172.3-286 266.5-410.5 236.1-0.2 0.2-0.5 0-0.7 0C311.5 916.7 192 801.8 129.1 636.5 51 430.7 90.8 225 217.5 177c82.2-31.3 180.9 11.6 261.7 101.7 124.3-118 273.4-161.9 370.8-97.1 124.3 83.1 116.6 312.7-17.1 512.7z" fill="#FFFFFF" p-id="2497"></path><path d="M471.2 960.2c-17.9 0-35.4-1.9-52.3-5.8-0.3 0-0.7-0.1-1-0.1C296.1 938.7 171 814.5 106.5 645.1 67.3 541.4 55.3 434.2 72.9 343c18.4-95.3 66.7-162.3 136.1-188.5 83.9-32 184.1 1.8 271.5 90.4 131.8-115.8 283.4-149.5 382.9-83.3C998.6 252 993.9 497 853 707.7 748.9 863.3 599.1 960.2 471.2 960.2z m-47.9-53.8c1.6 0 3.2 0.3 4.7 0.7 116.4 28.4 278.2-66.7 384.8-226.1C939 492.2 949.6 277.2 836.6 201.6c-84.9-56.5-221.8-18.5-340.8 94.6-4.7 4.5-11 7.1-17.6 6.6-6.5-0.3-12.6-3.2-17-8-77.3-86.3-165.2-121.9-235.1-95.2-53.2 20.1-90.9 74.3-105.9 152.6-15.9 82.5-4.7 180.4 31.5 275.8 57.2 150.5 168.7 264.7 271.6 278.4z m409.6-212.1h0.2-0.2z" fill="#FFFFFF" p-id="2498"></path><path d="M419.6 723.7c-3.5 0-7-0.8-10.3-2.3-12-5.7-17.1-20-11.5-32 1-2.2 25.9-53.9 77.1-67.5 32-8.5 65.9-0.5 100.6 23.8 0.7 0 4.7-1.6 6.9-5.2 19-31.2 56.6-92.4 117.6-85.6 13.2 1.5 22.7 13.4 21.3 26.6-1.5 13.2-13.6 22.6-26.6 21.3-30.7-3.7-56.3 38.5-70 61-9.5 15.5-23.6 25.6-39 28.8-13.5 2.8-26.9 0.2-37.8-7.5-22.3-15.7-42.6-21.4-60.3-16.8-29.5 7.7-46 41.3-46.2 41.6-4.2 8.8-12.8 13.8-21.8 13.8z" fill="#E50012" p-id="2499"></path></svg>
                <span>{{.Thread.GoodCount}}</span>
            </a>
        </div>
        <div class="t-reply">
            <div class="reply">
                <ul>
                    {{$thread := .Thread}}
                    {{if eq (len .Thread.Replies) 0}}
                    <li class="empty">暂无跟帖</li>
                    {{else}}
                    {{range .Thread.Replies}}
                    <li ondblclick="fastToReply(this)" data-author="{{.Author.Name}}">
                        <div class="author">
                            <a href="/profile/{{.Author.Name}}">{{if .Author.Name}}{{.Author.Name}}{{else}}__NameLoad_Error{{end}}</a>
                            {{if eq .Author.Name $thread.Author.Name}}<span>楼主</span>{{end}}
                        </div>
                        <div class="rc content">{{rwubb .Content}}</div>
                    </li>
                    {{end}}
                    {{end}}
                </ul>
            </div>
            <div class="to-reply" name="r">
                {{if .SiteContext.Session}}
                <div class="title">
                    跟帖
                </div>
                <textarea id="replyContent" placeholder="说点什么..."></textarea>
                <button id="replyBtn" onclick="reply(this)">评论该帖子</button>
                {{else}}
                <a href="/login.html?go={{.SiteContext.RequestURI}}">点我马上登录</a>，以跟评本帖
                {{end}}
            </div>
        </div>
    </div>
    <div class="faces" id="facesArea">
        <ul>
        </ul>
    </div>
    </main>
    <script>
        let article = document.querySelector('article')
        article.innerHTML = marked(article.innerHTML)
        article.querySelectorAll('img').forEach(i => {
            if(i.alt.startsWith('face-')) {
                i.classList += 'face-img'
                i.align = 'absmiddle'
            }
        })
        document.querySelectorAll('.rc').forEach(c => {
            c.innerHTML = marked(c.innerHTML)
            c.querySelectorAll('img').forEach(i => {
                if(i.alt.startsWith('face-')) {
                    i.classList += 'face-img'
                    i.align = 'absmiddle'
                }
            })
        })
    </script>
    <script>
        function fastToReply(item) {
            replyContent.value += '@'+item.getAttribute('data-author')+', '
            setTimeout(_=>replyContent.focus(), 100)
        }
        function reply(btn) {
            if (!replyContent.value) {
                replyContent.focus()
                return
            }
            btn.disabled = true
            btn.innerHTML = '评论中...'
            replyContent.disabled = true
            fetch('/api/v1/site/threads/{{.Thread.ID.Hex}}/reply', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    Content: replyContent.value
                })
            }).then(handleException).then(json => {
                window.localStorage.removeItem('threads-{{.Thread.ID.Hex}}-reply')
                window.location.reload()
            }).catch(e => {
                executeException(e)
                window.location.reload()
            })
        }

        replyContent.onblur = _=>{
            window.localStorage.setItem('threads-{{.Thread.ID.Hex}}-reply', replyContent.value)
            if(replyContent.value && !isShow()) {
                if(confirm('立即发布评论？')) {
                    setTimeout(_=>replyBtn.click(), 100)
                }
            }
        }
        replyContent.ondblclick = _ => {
            showFaces()
        }
        let rc = window.localStorage.getItem('threads-{{.Thread.ID.Hex}}-reply')
        if(rc) replyContent.value = rc
        let faces = ['不高兴','乖','冷','勉强','吐舌','吐','呵呵','呼','咦','哈哈','啊','喷','太开心','委屈','开心','怒','惊哭','惊讶','汗','泪','滑稽','狂汗','疑问','真棒','睡觉','笑眼','花心','鄙视','酷','钱','阴险','黑线']
        function showFaces() {
            facesArea.style.display = 'block'
            let faceContainer = document.querySelector('#facesArea ul')
            if(faceContainer.innerHTML.trim()) {
                return
            }
            for(i in faces) {
                k = faces[i]
                let li = '<li data-name="'+k+'" onclick="appendFace(this)"><img src="https://hu60.cn/img/face/'+toHexString(toUTF8Array(k))+'.gif" /></li>'
                faceContainer.innerHTML += li+'\n'
            }
            
        }
        function appendFace(f) {
            facesArea.style.display = 'none'
            replyContent.value += '{'+f.getAttribute('data-name')+'}'
            replyContent.focus()
        }
        function isShow() {
            return facesArea.style.display == 'block'
        }

        function good() {
            fetch('/api/v1/common/threads/{{.Thread.ID.Hex}}/good', {
                method: 'PATCH',
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(handleException).then(_=>{
                goodbtn.querySelector('span').innerHTML = Number(goodbtn.querySelector('span').innerHTML) +1
            }).catch(executeException)
        }
        function toUTF8Array(str) {
            var utf8 = [];
            for (var i=0; i < str.length; i++) {
                var charcode = str.charCodeAt(i);
                if (charcode < 0x80) utf8.push(charcode);
                else if (charcode < 0x800) {
                    utf8.push(0xc0 | (charcode >> 6), 
                            0x80 | (charcode & 0x3f));
                }
                else if (charcode < 0xd800 || charcode >= 0xe000) {
                    utf8.push(0xe0 | (charcode >> 12), 
                            0x80 | ((charcode>>6) & 0x3f), 
                            0x80 | (charcode & 0x3f));
                }
                // surrogate pair
                else {
                    i++;
                    // UTF-16 encodes 0x10000-0x10FFFF by
                    // subtracting 0x10000 and splitting the
                    // 20 bits of 0x0-0xFFFFF into two halves
                    charcode = 0x10000 + (((charcode & 0x3ff)<<10)
                            | (str.charCodeAt(i) & 0x3ff));
                    utf8.push(0xf0 | (charcode >>18), 
                            0x80 | ((charcode>>12) & 0x3f), 
                            0x80 | ((charcode>>6) & 0x3f), 
                            0x80 | (charcode & 0x3f));
                }
            }
            return utf8;
        }
        function toHexString(byteArray) {
            return Array.from(byteArray, function(byte) {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
            }).join('')
        }
    </script>
    {{rwctx .SiteContext.Site.Footer .SiteContext}}
</body></html>